# Runtime stage - Use official Red Hat Node.js 22 image
FROM registry.access.redhat.com/ubi9/nodejs-22:latest

# Set build arguments for labels
ARG ARGOCD_MCP_VERSION

# Add metadata labels
LABEL org.opencontainers.image.title="ArgoCD MCP Server" \
      org.opencontainers.image.description="Model Context Protocol server for ArgoCD" \
      org.opencontainers.image.vendor="MCP Playground" \
      org.opencontainers.image.source="https://github.com/akuity/argocd-mcp" \
      org.opencontainers.image.version="${ARGOCD_MCP_VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${BUILD_REF}" \
      org.opencontainers.image.licenses="Apache-2.0"

WORKDIR /app

USER root

# Update npm to the latest version
RUN npm install -g npm@latest argocd-mcp@$latest && \
    npm cache clean --force

# Create non-root user for security
RUN chown default:root /opt/app-root/src/.npm && \
    chmod g+rw -R /opt/app-root/src

USER default

# Expose port for HTTP stream transport
EXPOSE 3000

# Set entrypoint to use the shell wrapper for proper environment variable handling
ENTRYPOINT ["npm"]
