# Build arguments
ARG MCP_SERVER_VERSION=main
ARG MCP_SERVER_REPO=https://github.com/containers/kubernetes-mcp-server.git

# Build stage
FROM registry.access.redhat.com/ubi9/ubi:latest as builder

# Set build arguments
ARG MCP_SERVER_VERSION
ARG MCP_SERVER_REPO

WORKDIR /app
USER root

# Install build dependencies
RUN dnf install -y wget tar git make && \
    wget https://go.dev/dl/go1.24.1.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.24.1.linux-amd64.tar.gz && \
    rm -f go1.24.1.linux-amd64.tar.gz

ENV PATH="/usr/local/go/bin:${PATH}"

# Clone and build MCP server with specific version
RUN git clone ${MCP_SERVER_REPO} && \
    cd kubernetes-mcp-server && \
    git checkout ${MCP_SERVER_VERSION} && \
    make build

# Runtime stage
FROM registry.access.redhat.com/ubi9/ubi-minimal:latest

# Set build arguments for labels
ARG MCP_SERVER_VERSION
ARG MCP_SERVER_REPO

# Add metadata labels
LABEL org.opencontainers.image.title="Kubernetes MCP Server" \
      org.opencontainers.image.description="Model Context Protocol server for Kubernetes" \
      org.opencontainers.image.vendor="MCP Playground" \
      org.opencontainers.image.source="${MCP_SERVER_REPO}" \
      org.opencontainers.image.version="${MCP_SERVER_VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${BUILD_REF}" \
      org.opencontainers.image.licenses="Apache-2.0"

WORKDIR /app

# Copy binary from builder stage
COPY --from=builder /app/kubernetes-mcp-server/kubernetes-mcp-server /app/kubernetes-mcp-server

# Create non-root user for security
RUN adduser --system --no-create-home --uid 1000 mcpuser && \
    chown mcpuser:mcpuser /app/kubernetes-mcp-server

USER mcpuser

# Expose port
EXPOSE 8080

# Set entrypoint with configurable options
ENTRYPOINT ["./kubernetes-mcp-server", "--sse-port", "8080", "--log-level", "9"]