# Build arguments
ARG MCP_SERVER_VERSION=main
ARG MCP_SERVER_REPO=https://github.com/echelon-ai-labs/servicenow-mcp.git

# Build stage
FROM registry.access.redhat.com/ubi9/ubi:latest as builder

# Set build arguments
ARG MCP_SERVER_VERSION
ARG MCP_SERVER_REPO

WORKDIR /app
USER root

# Install build dependencies including Python
RUN dnf install -y python3.11 python3.11-pip python3.11-devel git gcc && \
    ln -s /usr/bin/python3.11 /usr/bin/python && \
    ln -s /usr/bin/pip3.11 /usr/bin/pip

# Clone and prepare MCP server with specific version
RUN git clone ${MCP_SERVER_REPO} && \
    cd servicenow-mcp && \
    git checkout ${MCP_SERVER_VERSION}

# Runtime stage
FROM registry.access.redhat.com/ubi9/ubi-minimal:latest

# Set build arguments for labels
ARG MCP_SERVER_VERSION
ARG MCP_SERVER_REPO

ARG BUILD_DATE
ARG BUILD_REF

# Add metadata labels
LABEL org.opencontainers.image.title="ServiceNow MCP Server" \
      org.opencontainers.image.description="Model Context Protocol server for ServiceNow" \
      org.opencontainers.image.vendor="MCP Playground" \
      org.opencontainers.image.source="${MCP_SERVER_REPO}" \
      org.opencontainers.image.version="${MCP_SERVER_VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${BUILD_REF}" \
      org.opencontainers.image.licenses="Apache-2.0"

WORKDIR /app

# Install Python and pip in runtime stage
RUN microdnf install -y python3.11 python3.11-pip && \
    ln -s /usr/bin/python3.11 /usr/bin/python && \
    ln -s /usr/bin/pip3.11 /usr/bin/pip && \
    microdnf clean all

# Copy project files from builder stage
COPY --from=builder /app/servicenow-mcp/pyproject.toml /app/servicenow-mcp/README.md /app/servicenow-mcp/LICENSE ./
COPY --from=builder /app/servicenow-mcp/src/ ./src/
COPY --from=builder /app/servicenow-mcp/config/ ./config/

# Install the package in development mode
RUN pip install -e .

# Create non-root user for security
RUN adduser --system --no-create-home --uid 1000 mcpuser && \
    chown -R mcpuser:mcpuser /app

USER mcpuser

# Expose port
EXPOSE 8080

# Set entrypoint with configurable options
CMD ["servicenow-mcp-sse", "--host=0.0.0.0", "--port=8080"]